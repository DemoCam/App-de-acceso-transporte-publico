{% extends 'base.html' %}

{% block content %}
<h1 class="mb-4">Paradas Cercanas</h1>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">Tu ubicación</h2>
            </div>
            <div class="card-body">
                <p id="ubicacionActual">Obteniendo ubicación...</p>
                
                <button id="btnObtenerUbicacion" class="btn btn-primary">
                    <i class="bi bi-geo-alt"></i> Actualizar mi ubicación
                </button>
                
                <div class="mt-3">
                    <label for="direccionBusqueda" class="form-label">O busca una dirección:</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="direccionBusqueda" 
                               placeholder="Ej: Calle 5 #34-20">
                        <button class="btn btn-outline-secondary" type="button" id="btnBuscarDireccion">Buscar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h2 class="h5 mb-0">Opciones de búsqueda</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="distanciaMaxima" class="form-label">Distancia máxima:</label>
                    <select class="form-select" id="distanciaMaxima" aria-describedby="distanciaHelp">
                        <option value="300">300 metros</option>
                        <option value="500" selected>500 metros</option>
                        <option value="1000">1 kilómetro</option>
                        <option value="2000">2 kilómetros</option>
                    </select>
                    <div id="distanciaHelp" class="form-text">Distancia máxima para buscar paradas desde tu ubicación</div>
                </div>
                
                <div class="mb-3">
                    <label for="filtroRuta" class="form-label">Filtrar por ruta (opcional):</label>
                    <input type="text" class="form-control" id="filtroRuta" placeholder="Ej: T31, P10..." 
                           aria-describedby="rutaHelp" list="rutasSugeridas">
                    <datalist id="rutasSugeridas">
                        <!-- Las opciones se cargarán dinámicamente -->
                    </datalist>
                    <div id="rutaHelp" class="form-text">Ingresa el número de la ruta para filtrar resultados</div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="filtroAccesibilidad">
                        <label class="form-check-label" for="filtroAccesibilidad">
                            Solo paradas con accesibilidad (rampa o semáforo sonoro)
                        </label>
                    </div>
                </div>
                
                <button id="btnBuscarParadas" class="btn btn-success w-100 mt-2">
                    <i class="bi bi-search"></i> Buscar paradas cercanas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mapa de ubicación (será implementado con Leaflet.js) -->
<div class="card mb-4">
    <div class="card-header">
        <h2 class="h5 mb-0">Mapa de ubicación</h2>
    </div>
    <div class="card-body p-0">
        <div id="mapaParadas" style="height: 400px; background-color: #f0f0f0;">
            <p class="text-center py-5">
                El mapa se cargará al obtener tu ubicación.
            </p>
        </div>
    </div>
</div>

<!-- Lista de paradas cercanas -->
<div class="card">
    <div class="card-header">
        <h2 class="h5 mb-0">Paradas cercanas</h2>
    </div>
    <div class="card-body">
        <div id="paradasCercanas">
            <p class="text-center">
                Haz clic en "Buscar paradas cercanas" para ver las paradas próximas a tu ubicación.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
<style>
    /* Estilos personalizados para los marcadores */
    .parada-terminal .leaflet-marker-icon {
        filter: hue-rotate(0deg);
    }
    
    .parada-estacion .leaflet-marker-icon {
        filter: hue-rotate(220deg);
    }
    
    .parada-regular .leaflet-marker-icon {
        filter: hue-rotate(120deg);
    }
    
    /* Estilos para la lista de paradas */
    .paradas-lista .list-group-item:focus {
        outline: 2px solid #007bff;
    }
    
    .rutas-container {
        max-width: 100%;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    /* Estilos para el popup del mapa */
    .popup-parada {
        max-width: 300px;
    }
    
    .rutas-chip {
        margin-top: 4px;
        max-width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 4px;
    }
    
    /* Ajustes para accesibilidad */
    .badge {
        font-size: 0.9em;
    }
    
    #mapaParadas {
        border: 1px solid #ddd;
    }
    
    @media (max-width: 768px) {
        #mapaParadas {
            height: 300px !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let map, userMarker;
    let userPosition = null;
    
    // Inicializar el mapa cuando se carga la página
    function inicializarMapa() {
        map = L.map('mapaParadas').setView([3.4516, -76.5320], 13); // Coordenadas de Cali
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        document.getElementById('mapaParadas').innerHTML = '';
    }
    
    // Obtener la ubicación del usuario
    function obtenerUbicacion() {
        document.getElementById('ubicacionActual').innerHTML = 'Obteniendo ubicación...';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    document.getElementById('ubicacionActual').innerHTML = 
                        `Ubicación obtenida: Latitud ${userPosition.lat.toFixed(5)}, Longitud ${userPosition.lng.toFixed(5)}`;
                    
                    // Inicializar el mapa si aún no se ha hecho
                    if (!map) {
                        inicializarMapa();
                    }
                    
                    // Centrar el mapa en la ubicación del usuario
                    map.setView([userPosition.lat, userPosition.lng], 16);
                    
                    // Agregar marcador de ubicación del usuario
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: '<div style="background-color: #007bff; border-radius: 50%; width: 16px; height: 16px; border: 2px solid white;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    // Anunciar con el asistente de voz
                    if (typeof anunciarMensaje === 'function') {
                        anunciarMensaje('Ubicación obtenida. Ya puedes buscar paradas cercanas.');
                    }
                },
                function(error) {
                    console.error('Error al obtener ubicación:', error);
                    let mensaje = 'Error al obtener tu ubicación. ';
                    
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            mensaje += 'Permiso denegado para acceder a tu ubicación.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensaje += 'La información de ubicación no está disponible.';
                            break;
                        case error.TIMEOUT:
                            mensaje += 'Se agotó el tiempo para obtener tu ubicación.';
                            break;
                        default:
                            mensaje += 'Error desconocido.';
                    }
                    
                    document.getElementById('ubicacionActual').innerHTML = mensaje;
                    
                    // Si hay error, inicializar el mapa con vista general de Cali
                    if (!map) {
                        inicializarMapa();
                    }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            document.getElementById('ubicacionActual').innerHTML = 
                'Tu navegador no soporta geolocalización.';
            
            // Inicializar mapa con vista general de Cali
            if (!map) {
                inicializarMapa();
            }
        }
    }
    
    // Buscar paradas cercanas usando la API
    async function buscarParadasCercanas() {
        if (!userPosition) {
            alert('Primero debes obtener tu ubicación.');
            if (typeof anunciarMensaje === 'function') {
                anunciarMensaje('Primero debes obtener tu ubicación.');
            }
            return;
        }
        
        const distancia = document.getElementById('distanciaMaxima').value;
        const soloAccesibles = document.getElementById('filtroAccesibilidad').checked;
        const rutaFiltro = document.getElementById('filtroRuta').value.trim();
        
        document.getElementById('paradasCercanas').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p>Buscando paradas cercanas...</p>
            </div>
        `;
        
        try {
            // Construir la URL para la API con los parámetros
            let apiUrl = `/api/paradas/cercanas?lat=${userPosition.lat}&lng=${userPosition.lng}&distancia=${distancia}`;
            
            // Añadir parámetro de ruta si se especificó
            if (rutaFiltro) {
                apiUrl += `&ruta=${encodeURIComponent(rutaFiltro)}`;
            }
            
            // Llamada real a la API
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error('Error en la respuesta de la API');
            }
            
            const data = await response.json();
            
            if (data.status === 'success' && Array.isArray(data.paradas)) {
                mostrarParadasCercanas(data.paradas, soloAccesibles, rutaFiltro);
                
                let mensaje = `Se encontraron ${data.paradas.length} paradas cercanas`;
                if (rutaFiltro) {
                    mensaje += ` para la ruta ${rutaFiltro}`;
                }
                
                if (typeof anunciarMensaje === 'function') {
                    anunciarMensaje(mensaje);
                }
            } else {
                throw new Error('Formato de respuesta inválido');
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('paradasCercanas').innerHTML = `
                <div class="alert alert-danger">
                    Error al buscar paradas cercanas. Por favor intenta de nuevo más tarde.
                </div>
            `;
            
            if (typeof anunciarMensaje === 'function') {
                anunciarMensaje('Error al buscar paradas cercanas');
            }
        }
    }
    
    // Mostrar las paradas cercanas en el mapa y la lista
    function mostrarParadasCercanas(paradas, soloAccesibles, rutaFiltro) {
        // Filtrar por accesibilidad si es necesario
        if (soloAccesibles) {
            paradas = paradas.filter(p => 
                p.accesibilidad.rampa || p.accesibilidad.semaforo_sonoro
            );
        }
        
        // Filtrar por ruta si se especifica
        if (rutaFiltro) {
            paradas = paradas.filter(p => 
                p.rutas && p.rutas.some(ruta => ruta.toLowerCase().includes(rutaFiltro.toLowerCase()))
            );
        }
        
        // Limpiar marcadores anteriores (excepto el del usuario)
        map.eachLayer(layer => {
            if (layer instanceof L.TileLayer) {
                // Mantener el mapa base
                return;
            }
            if (layer !== userMarker) {
                map.removeLayer(layer);
            }
        });
        
        // Añadir de nuevo el marcador del usuario si existe
        if (userMarker && !map.hasLayer(userMarker)) {
            userMarker.addTo(map);
        }
        
        // Crear iconos personalizados para diferentes tipos de paradas
        const iconos = {
            terminal: L.icon({
                iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-shadow.png',
                shadowSize: [41, 41],
                className: 'parada-terminal'
            }),
            estación: L.icon({
                iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-shadow.png',
                shadowSize: [41, 41],
                className: 'parada-estacion'
            }),
            regular: L.icon({
                iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-shadow.png',
                shadowSize: [41, 41],
                className: 'parada-regular'
            })
        };
        
        // Crear un grupo para los marcadores
        const markersGroup = L.featureGroup();
        
        // Mostrar las paradas en el mapa
        paradas.forEach(parada => {
            const tipoIcono = parada.tipo in iconos ? parada.tipo : 'regular';
            const marker = L.marker([parada.latitud, parada.longitud], {
                title: parada.nombre,
                icon: iconos[tipoIcono],
                alt: `Parada: ${parada.nombre}`
            });
            
            marker.bindPopup(`
                <div class="popup-parada">
                    <strong>${parada.nombre}</strong><br>
                    ${parada.direccion}<br>
                    <div class="mt-2">
                        <strong>Tipo:</strong> ${parada.tipo.charAt(0).toUpperCase() + parada.tipo.slice(1)}<br>
                        <strong>Accesibilidad:</strong>
                        ${parada.accesibilidad.rampa ? '<span class="text-success">✓ Rampa</span><br>' : '<span class="text-secondary">✗ Sin rampa</span><br>'}
                        ${parada.accesibilidad.semaforo_sonoro ? '<span class="text-success">✓ Semáforo sonoro</span>' : '<span class="text-secondary">✗ Sin semáforo sonoro</span>'}
                    </div>
                    <div class="mt-2">
                        <strong>Rutas:</strong><br>
                        <div class="rutas-chip">
                            ${parada.rutas.map(ruta => `<span class="badge bg-info me-1">${ruta}</span>`).join('')}
                        </div>
                    </div>
                    ${parada.distancia ? `<div class="mt-2"><strong>Distancia:</strong> ${parada.distancia} metros</div>` : ''}
                </div>
            `);
            
            marker.addTo(map);
            markersGroup.addLayer(marker);
        });
        
        // Si tenemos paradas, ajustar la vista para mostrarlas todas incluyendo la posición del usuario
        if (paradas.length > 0) {
            if (userMarker) {
                markersGroup.addLayer(userMarker);
            }
            
            // Ajustar el mapa para mostrar todas las paradas
            try {
                const bounds = markersGroup.getBounds();
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 16
                });
            } catch (e) {
                console.error('Error al ajustar el mapa:', e);
                
                // Si hay error, centrar en el usuario o la primera parada
                if (userMarker) {
                    map.setView(userMarker.getLatLng(), 15);
                } else if (paradas.length > 0) {
                    map.setView([paradas[0].latitud, paradas[0].longitud], 15);
                }
            }
        }
        
        // Mostrar lista de paradas
        const html = paradas.length > 0 ? `
            <div class="list-group paradas-lista">
                ${paradas.map(parada => `
                    <a href="#" class="list-group-item list-group-item-action parada-item" 
                       data-lat="${parada.latitud}" data-lng="${parada.longitud}"
                       role="button" aria-label="Ver parada ${parada.nombre}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                <span class="badge rounded-pill bg-${parada.tipo === 'terminal' ? 'danger' : parada.tipo === 'estación' ? 'primary' : 'secondary'} me-1">
                                    ${parada.tipo.charAt(0).toUpperCase()}
                                </span>
                                ${parada.nombre}
                            </h5>
                            <small>${parada.distancia} m</small>
                        </div>
                        <p class="mb-1">${parada.direccion}</p>
                        <div>
                            ${parada.accesibilidad.rampa ? 
                                '<span class="badge bg-success me-1" title="Rampa accesible"><i class="bi bi-wheelchair"></i> Rampa</span>' : ''}
                            ${parada.accesibilidad.semaforo_sonoro ? 
                                '<span class="badge bg-success" title="Semáforo con señal sonora"><i class="bi bi-volume-up"></i> Semáforo sonoro</span>' : ''}
                        </div>
                        <div class="mt-2 rutas-container">
                            <small>Rutas: </small>
                            <div class="d-inline-block">
                                ${parada.rutas.map(ruta => `<span class="badge bg-info me-1">${ruta}</span>`).join('')}
                            </div>
                        </div>
                    </a>
                `).join('')}
            </div>
        ` : '<p class="text-center">No se encontraron paradas cercanas con los filtros seleccionados.</p>';
        
        document.getElementById('paradasCercanas').innerHTML = html;
        
        // Añadir eventos a los elementos de la lista
        document.querySelectorAll('.parada-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const lat = parseFloat(this.getAttribute('data-lat'));
                const lng = parseFloat(this.getAttribute('data-lng'));
                
                map.setView([lat, lng], 18);
                
                // Buscar y abrir el popup correspondiente
                map.eachLayer(layer => {
                    if (layer.options && layer.options.title && 
                        layer.getLatLng().lat === lat && 
                        layer.getLatLng().lng === lng) {
                        layer.openPopup();
                    }
                });
            });
        });
    }
    
    // Calcular distancia aproximada entre dos puntos (en metros)
    function calcularDistancia(pos1, pos2) {
        // Fórmula de Haversine simplificada para distancias cortas
        const R = 6371000; // Radio de la Tierra en metros
        const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
        const dLng = (pos2.lng - pos1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const d = R * c;
        return Math.round(d); // Distancia en metros, redondeada
    }
    
    // Cargar rutas para el selector de filtro
    async function cargarRutasParaFiltro() {
        try {
            const response = await fetch('/api/rutas');
            if (!response.ok) {
                throw new Error('Error al cargar rutas');
            }
            
            const data = await response.json();
            if (data.status === 'success' && Array.isArray(data.rutas)) {
                const datalist = document.getElementById('rutasSugeridas');
                
                // Limpiar datalist existente
                datalist.innerHTML = '';
                
                // Añadir opciones para cada ruta
                data.rutas.forEach(ruta => {
                    const option = document.createElement('option');
                    option.value = ruta.numero;
                    option.textContent = `${ruta.numero} - ${ruta.nombre}`;
                    datalist.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error al cargar rutas para filtro:', error);
        }
    }
    
    // Eventos
    document.getElementById('btnObtenerUbicacion').addEventListener('click', obtenerUbicacion);
    document.getElementById('btnBuscarParadas').addEventListener('click', buscarParadasCercanas);
    
    // Permitir búsqueda al presionar Enter en el filtro de ruta
    document.getElementById('filtroRuta').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarParadasCercanas();
        }
    });
    
    // Inicializar mapa, obtener ubicación y cargar rutas para filtro
    inicializarMapa();
    obtenerUbicacion();
    cargarRutasParaFiltro();
});
</script>
{% endblock %}
